// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

model User {
  id                String    @id @default(cuid())
  email             String    @unique
  name              String?
  phone             String?
  avatar            String?
  language          String    @default("es") // es, en
  timezone          String    @default("UTC")
  googleCalendarId  String?
  googleAccessToken String?
  googleRefreshToken String?
  referralCode      String?   @unique // Código único para referidos
  referredBy        String?   // Quién refirió a este usuario
  createdAt         DateTime  @default(now())
  updatedAt         DateTime  @updatedAt
  events            Event[]
  tasks             Task[]
  accounts          Account[]
  sessions          Session[]
  subscription      Subscription?
  usage             Usage[]
  goals             Goal[]
  habits            Habit[]
  achievements      UserAchievement[]
  rewards           UserReward[]
  flwyTokens        FlwyToken[]
  referralsMade     Referral[] @relation("Referrer") // Usuarios que este usuario ha referido
  referredIn        Referral[] @relation("Referred") // Referidos donde este usuario es el referred
}

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

model Subscription {
  id            String    @id @default(cuid())
  userId        String    @unique
  stripeId      String?   @unique
  plan          String    // free, premium, business
  status        String    // active, cancelled, expired, past_due
  currentPeriodStart DateTime @default(now())
  currentPeriodEnd   DateTime?
  cancelAtPeriodEnd Boolean   @default(false)
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  user          User      @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Usage {
  id         String   @id @default(cuid())
  userId     String
  feature    String   // events, tasks, categories
  count      Int      @default(0)
  date       DateTime @default(now())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, feature, date])
}

model Goal {
  id          String   @id @default(cuid())
  userId      String
  title       String
  description String?
  target      Int      // número objetivo
  current     Int      @default(0)
  unit        String   // "tareas", "minutos", "veces", etc.
  category    String   // "work", "health", "personal", "learning"
  deadline    DateTime?
  status      String   @default("active") // active, completed, paused
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  milestones  GoalMilestone[]
}

model GoalMilestone {
  id          String   @id @default(cuid())
  goalId      String
  title       String
  target      Int
  completed   Boolean  @default(false)
  createdAt   DateTime @default(now())
  goal        Goal     @relation(fields: [goalId], references: [id], onDelete: Cascade)

  @@unique([goalId, title])
}

model Habit {
  id            String   @id @default(cuid())
  userId        String
  name          String
  description    String?
  frequency     String   // "daily", "weekly", "monthly"
  targetCount    Int      @default(1)
  currentStreak Int      @default(0)
  bestStreak    Int      @default(0)
  isActive      Boolean  @default(true)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  completions   HabitCompletion[]
}

model HabitCompletion {
  id        String   @id @default(cuid())
  habitId   String
  date      DateTime @default(now())
  completed Boolean  @default(true)
  habit     Habit    @relation(fields: [habitId], references: [id], onDelete: Cascade)

  @@unique([habitId, date])
}

model Achievement {
  id          String   @id @default(cuid())
  name        String
  description String
  icon        String
  category    String   // "productivity", "consistency", "milestone"
  flwyReward  Int      @default(0) // tokens de FLWY otorgados
  requirement String   // JSON con condiciones para desbloquear
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  users       UserAchievement[]
}

model Referral {
  id           String   @id @default(cuid())
  referrerId   String   // Usuario que refirió
  referredId   String   // Usuario referido
  status       String   @default("pending") // pending, completed, rewarded
  flwyReward   Int      @default(50) // Tokens FLWY para el referrer
  completedAt  DateTime?
  rewardedAt   DateTime?
  createdAt    DateTime @default(now())
  
  referrer   User @relation("Referrer", fields: [referrerId], references: [id], onDelete: Cascade)
  referred   User @relation("Referred", fields: [referredId], references: [id], onDelete: Cascade)

  @@unique([referrerId, referredId])
}

model UserAchievement {
  id            String   @id @default(cuid())
  userId        String
  achievementId  String
  unlockedAt    DateTime @default(now())
  user          User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  achievement   Achievement @relation(fields: [achievementId], references: [id], onDelete: Cascade)

  @@unique([userId, achievementId])
}

model Reward {
  id          String   @id @default(cuid())
  name        String
  description String
  icon        String
  flwyCost    Int      // costo en tokens FLWY
  category    String   // "themes", "features", "badges", "discounts"
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  users       UserReward[]
}

model UserReward {
  id        String   @id @default(cuid())
  userId    String
  rewardId  String
  redeemedAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  reward    Reward   @relation(fields: [rewardId], references: [id], onDelete: Cascade)

  @@unique([userId, rewardId])
}

model FlwyToken {
  id          String   @id @default(cuid())
  userId      String
  amount      Int      @default(0)
  source      String   // "achievement", "goal", "habit", "streak", "purchase"
  sourceId    String?  // ID del logro, meta, etc.
  createdAt   DateTime @default(now())
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model Category {
  id          String   @id @default(cuid())
  name        String   @unique
  color       String   @default("#3B82F6")
  icon        String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  events      Event[]
  tasks       Task[]
}

model Event {
  id          String    @id @default(cuid())
  title       String
  description String?
  startDate   DateTime
  endDate     DateTime
  isAllDay    Boolean   @default(false)
  location    String?
  whatsapp    Boolean   @default(false)
  status      String    @default("pending") // pending, confirmed, cancelled
  userId      String
  categoryId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    Category? @relation(fields: [categoryId], references: [id])
  reminders   Reminder[]
}

model Task {
  id          String    @id @default(cuid())
  title       String
  description String?
  dueDate     DateTime?
  priority    String    @default("medium") // low, medium, high
  status      String    @default("todo") // todo, in_progress, completed
  userId      String
  categoryId  String?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  category    Category? @relation(fields: [categoryId], references: [id])
}

model Reminder {
  id        String   @id @default(cuid())
  eventId   String
  minutes   Int      @default(15) // minutes before event
  sent      Boolean  @default(false)
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id], onDelete: Cascade)
}